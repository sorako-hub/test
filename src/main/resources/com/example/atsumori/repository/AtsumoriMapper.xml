<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.atsumori.repository.AtsumoriMapper">

    <!-- AppearancePeriod用resultMap -->
    <resultMap id="AppearancePeriodResultMap" type="com.example.atsumori.entity.AppearancePeriod">
        <id property="id" column="period_id"/>
        <result property="hemisphere" column="hemisphere"/>
        <result property="startMonth" column="start_month"/>
        <result property="endMonth" column="end_month"/>
    </resultMap>

    <!-- AppearanceTime用resultMap -->
    <resultMap id="AppearanceTimeResultMap" type="com.example.atsumori.entity.AppearanceTime">
        <id property="id" column="time_id"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
    </resultMap>

    <!-- Area用resultMap -->
    <resultMap id="AreaResultMap" type="com.example.atsumori.entity.Area">
        <id property="id" column="area_id"/>
        <result property="name" column="area_name"/>
    </resultMap>

    <!-- Creatures用resultMap -->
    <resultMap id="CreaturesResultMap" type="com.example.atsumori.entity.Creatures">
    <id property="id" column="id"/>
    <result property="name" column="name"/>
    <result property="price" column="price"/>
    <result property="type" column="type"/>
    
    <collection property="areas" resultMap="AreaResultMap"/>
    <collection property="appearancePeriods" resultMap="AppearancePeriodResultMap"/>
    <collection property="appearanceTimes" resultMap="AppearanceTimeResultMap"/>
	</resultMap>


    <!-- 生き物全件取得 -->
    <select id="selectAll" resultMap="CreaturesResultMap">
        SELECT 
            c.id, c.name, c.price, c.type,

            a.id AS area_id,
            a.name AS area_name,

            ap.id AS period_id,
            ap.hemisphere,
            ap.start_month,
            ap.end_month,

            at.id AS time_id,
            at.start_time,
            at.end_time

        FROM creatures c
        LEFT JOIN creature_areas ca ON c.id = ca.creature_id
        LEFT JOIN areas a ON ca.area_id = a.id

        LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id
        LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

        LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
        LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

        ORDER BY c.id
    </select>
    
     <!-- タイプ別で取得 -->
    <select id="selectByType" parameterType="string" resultMap="CreaturesResultMap">
        SELECT 
            c.id, c.name, c.price, c.type,

            a.id AS area_id,
            a.name AS area_name,

            ap.id AS period_id,
            ap.hemisphere,
            ap.start_month,
            ap.end_month,

            at.id AS time_id,
            at.start_time,
            at.end_time

        FROM creatures c
        LEFT JOIN creature_areas ca ON c.id = ca.creature_id
        LEFT JOIN areas a ON ca.area_id = a.id

        LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id
        LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

        LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
        LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id
        
        WHERE c.type = #{type}
        ORDER BY c.id
    </select>

    <!-- 名前とタイプで取得 -->
    <select id="selectByNameAndType" parameterType="map" resultMap="CreaturesResultMap">
  	  SELECT 
        c.id, c.name, c.price, c.type,

        a.id AS area_id,
        a.name AS area_name,

        ap.id AS period_id,
        ap.hemisphere,
        ap.start_month,
        ap.end_month,

        at.id AS time_id,
        at.start_time,
        at.end_time

    FROM creatures c
    LEFT JOIN creature_areas ca ON c.id = ca.creature_id
    LEFT JOIN areas a ON ca.area_id = a.id

    LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id
    LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

    LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
    LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

    WHERE c.name = #{name} AND c.type = #{type}
	</select>


    <!-- 月・半球で出現（タイプ付き）※Java側フィルタ推奨 -->
    <select id="selectByAppearance" parameterType="map" resultMap="CreaturesResultMap">
        <![CDATA[
        SELECT 
            c.id, c.name, c.price, c.type,

            a.id AS area_id,
            a.name AS area_name,

            ap.id AS period_id,
            ap.hemisphere,
            ap.start_month,
            ap.end_month,

            at.id AS time_id,
            at.start_time,
            at.end_time

        FROM creatures c
        LEFT JOIN creature_areas ca ON c.id = ca.creature_id
        LEFT JOIN areas a ON ca.area_id = a.id

        LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id      
        LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

        LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
        LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

        WHERE
            c.type = #{type}
            AND (ap.hemisphere = #{hemisphere} OR ap.hemisphere IS NULL)
            AND (
                (ap.start_month <= ap.end_month AND #{month} BETWEEN ap.start_month AND ap.end_month)
                OR
                (ap.start_month > ap.end_month AND (#{month} >= ap.start_month OR #{month} <= ap.end_month))
            )
        ORDER BY c.id
        ]]>
    </select>
    
    <select id="selectById" parameterType="long" resultMap="CreaturesResultMap">
  SELECT 
      c.id, c.name, c.price, c.type,

      a.id AS area_id,
      a.name AS area_name,

      ap.id AS period_id,
      ap.hemisphere,
      ap.start_month,
      ap.end_month,

      at.id AS time_id,
      at.start_time,
      at.end_time

  FROM creatures c
  LEFT JOIN creature_areas ca ON c.id = ca.creature_id
  LEFT JOIN areas a ON ca.area_id = a.id

  LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id
  LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

  LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
  LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

  WHERE c.id = #{id}
  
  
</select>
    
    
	<select id="findByIdNotIn" parameterType="list" resultMap="CreaturesResultMap">
  SELECT 
      c.id, c.name, c.price, c.type,

      a.id AS area_id,
      a.name AS area_name,

      ap.id AS period_id,
      ap.hemisphere,
      ap.start_month,
      ap.end_month,

      at.id AS time_id,
      at.start_time,
      at.end_time

  FROM creatures c
  LEFT JOIN creature_areas ca ON c.id = ca.creature_id
  LEFT JOIN areas a ON ca.area_id = a.id

  LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id
  LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

  LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
  LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

  <if test="list != null and list.size() > 0">
    WHERE c.id NOT IN
    <foreach item="id" collection="list" open="(" separator="," close=")">
      #{id}
    </foreach>
  </if>
</select>

<!-- ✅ 取得済み生き物一覧（タイプ付き） -->
    <select id="selectCaughtCreaturesByType" parameterType="map" resultMap="CreaturesResultMap">
  SELECT 
      c.id, c.name, c.price, c.type,

      a.id AS area_id,
      a.name AS area_name,

      ap.id AS period_id,
      ap.hemisphere,
      ap.start_month,
      ap.end_month,

      at.id AS time_id,
      at.start_time,
      at.end_time

  FROM creatures c
  INNER JOIN caught_creatures cc ON c.id = cc.creature_id
  LEFT JOIN creature_areas ca ON c.id = ca.creature_id
  LEFT JOIN areas a ON ca.area_id = a.id

  LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id
  LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

  LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
  LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

  WHERE cc.user_id = #{userId} AND c.type = #{type}
  ORDER BY c.id
</select>

<!-- ✅ 未取得生き物一覧（タイプ付き） -->
    <select id="selectUncaughtCreaturesByType" parameterType="map" resultMap="CreaturesResultMap">
  SELECT 
      c.id, c.name, c.price, c.type,

      a.id AS area_id,
      a.name AS area_name,

      ap.id AS period_id,
      ap.hemisphere,
      ap.start_month,
      ap.end_month,

      at.id AS time_id,
      at.start_time,
      at.end_time

  FROM creatures c
  LEFT JOIN caught_creatures cc ON c.id = cc.creature_id AND cc.user_id = #{userId}
  LEFT JOIN creature_areas ca ON c.id = ca.creature_id
  LEFT JOIN areas a ON ca.area_id = a.id

  LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id
  LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

  LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
  LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

   WHERE cc.creature_id IS NULL AND c.type = #{type}
   ORDER BY c.id
</select>

 <!-- ✅ 取得済み（指定月・半球・タイプ） -->
<select id="selectCaughtCreaturesByAppearanceAndType" parameterType="map" resultMap="CreaturesResultMap">
  <![CDATA[
  SELECT 
      c.id, c.name, c.price, c.type,

      a.id AS area_id,
      a.name AS area_name,

      ap.id AS period_id,
      ap.hemisphere,
      ap.start_month,
      ap.end_month,

      at.id AS time_id,
      at.start_time,
      at.end_time

  FROM creatures c
  INNER JOIN caught_creatures cc ON c.id = cc.creature_id
  LEFT JOIN creature_areas ca ON c.id = ca.creature_id
  LEFT JOIN areas a ON ca.area_id = a.id

  LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id      
  LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

  LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
  LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

   WHERE cc.user_id = #{userId}
          AND c.type = #{type}
          AND (ap.hemisphere = #{hemisphere} OR ap.hemisphere IS NULL)
          AND (
              (ap.start_month <= ap.end_month AND #{month} BETWEEN ap.start_month AND ap.end_month)
              OR
              (ap.start_month > ap.end_month AND (#{month} >= ap.start_month OR #{month} <= ap.end_month))
          )
   ORDER BY c.id
  ]]>
</select>

<!-- ✅ 未取得（指定月・半球・タイプ） -->
    <select id="selectUncaughtCreaturesByAppearanceAndType" parameterType="map" resultMap="CreaturesResultMap">
  <![CDATA[
  SELECT 
      c.id, c.name, c.price, c.type,

      a.id AS area_id,
      a.name AS area_name,

      ap.id AS period_id,
      ap.hemisphere,
      ap.start_month,
      ap.end_month,

      at.id AS time_id,
      at.start_time,
      at.end_time

  FROM creatures c
  LEFT JOIN caught_creatures cf ON c.id = cf.creature_id AND cf.user_id = #{userId} LEFT JOIN caught_creatures cc ON c.id = cc.creature_id AND cc.user_id = #{userId}
  LEFT JOIN creature_areas ca ON c.id = ca.creature_id
  LEFT JOIN areas a ON ca.area_id = a.id

  LEFT JOIN creature_appearance_periods cap ON c.id = cap.creature_id      
  LEFT JOIN appearance_periods ap ON cap.appearance_period_id = ap.id

  LEFT JOIN creature_appearance_times cat ON c.id = cat.creature_id
  LEFT JOIN appearance_times at ON cat.appearance_time_id = at.id

   WHERE cc.creature_id IS NULL
          AND c.typ4e = #{type}
          AND (ap.hemisphere = #{hemisphere} OR ap.hemisphere IS NULL)
          AND (
              (ap.start_month <= ap.end_month AND #{month} BETWEEN ap.start_month AND ap.end_month)
              OR
              (ap.start_month > ap.end_month AND (#{month} >= ap.start_month OR #{month} <= ap.end_month))
          )
   ORDER BY c.id
  ]]>
</select>


</mapper>
